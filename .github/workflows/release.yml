name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.2)'
        required: true
        type: string

jobs:
  release:
    permissions:
      contents: write
    runs-on: macos-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        run: |
          brew install rustup
          rustup-init -y --default-toolchain stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustup target add aarch64-apple-darwin x86_64-apple-darwin

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: macos-universal-cargo-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            macos-universal-cargo-

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        run: npm ci

      - name: Set up Apple certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH
          security create-keychain -p "actions" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "actions" $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "actions" $KEYCHAIN_PATH
          security list-keychains -d user -s $KEYCHAIN_PATH login.keychain-db
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Build universal server sidecar
        run: |
          mkdir -p src-tauri/binaries

          # Build ARM64 natively
          bun build server/index.js --compile --outfile src-tauri/binaries/mailvault-server-aarch64-apple-darwin
          chmod +x src-tauri/binaries/mailvault-server-aarch64-apple-darwin

          # Download x86_64 Bun and build x86_64 sidecar
          curl -fsSL -o /tmp/bun-x64.zip "https://github.com/oven-sh/bun/releases/latest/download/bun-darwin-x64.zip"
          unzip -o /tmp/bun-x64.zip -d /tmp/bun-x64
          arch -x86_64 /tmp/bun-x64/bun-darwin-x64/bun build server/index.js --compile --outfile src-tauri/binaries/mailvault-server-x86_64-apple-darwin
          chmod +x src-tauri/binaries/mailvault-server-x86_64-apple-darwin

          # Create universal binary
          lipo -create \
            src-tauri/binaries/mailvault-server-aarch64-apple-darwin \
            src-tauri/binaries/mailvault-server-x86_64-apple-darwin \
            -output src-tauri/binaries/mailvault-server-universal-apple-darwin
          chmod +x src-tauri/binaries/mailvault-server-universal-apple-darwin

          echo "Universal binary:"
          file src-tauri/binaries/mailvault-server-universal-apple-darwin

      - name: Build, sign, notarize, and package
        env:
          CI: 'true'
          BUILD_TARGET: universal-apple-darwin
          SKIP_SERVER_BUILD: 'true'
          SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: bash scripts/build-developer-id.sh

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          BUNDLE_DIR="src-tauri/target/universal-apple-darwin/release/bundle"
          DMG_DIR="$BUNDLE_DIR/dmg"

          # Find our signed artifacts (not Tauri's unsigned ones)
          VERSION_NUM="${VERSION#v}"
          DMG="$DMG_DIR/MailVault-v${VERSION_NUM}.dmg"
          TAR_GZ="$DMG_DIR/MailVault.app.tar.gz"
          TAR_GZ_SIG="${TAR_GZ}.sig"
          LATEST_JSON="$DMG_DIR/latest.json"

          # Update latest.json URLs with the release version tag
          if [ -f "$LATEST_JSON" ]; then
            # Replace version placeholder with actual release tag version
            TAR_GZ_NAME=$(basename "$TAR_GZ")
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/${TAR_GZ_NAME}"
            # Rewrite latest.json with correct download URLs and version
            SIGNATURE=$(cat "$TAR_GZ_SIG" 2>/dev/null || echo "")
            PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
            cat > "$LATEST_JSON" <<EOJSON
          {
            "version": "${VERSION#v}",
            "notes": "See the assets to download and install this version.",
            "pub_date": "${PUB_DATE}",
            "platforms": {
              "darwin-aarch64": { "signature": "${SIGNATURE}", "url": "${DOWNLOAD_URL}" },
              "darwin-x86_64": { "signature": "${SIGNATURE}", "url": "${DOWNLOAD_URL}" },
              "darwin-aarch64-app": { "signature": "${SIGNATURE}", "url": "${DOWNLOAD_URL}" },
              "darwin-x86_64-app": { "signature": "${SIGNATURE}", "url": "${DOWNLOAD_URL}" }
            }
          }
          EOJSON
            echo "Updated latest.json with release URLs"
          fi

          # Collect upload files
          UPLOAD_FILES=""
          [ -f "$DMG" ] && UPLOAD_FILES="$UPLOAD_FILES $DMG"
          [ -f "$TAR_GZ" ] && UPLOAD_FILES="$UPLOAD_FILES $TAR_GZ"
          [ -f "$TAR_GZ_SIG" ] && UPLOAD_FILES="$UPLOAD_FILES $TAR_GZ_SIG"
          [ -f "$LATEST_JSON" ] && UPLOAD_FILES="$UPLOAD_FILES $LATEST_JSON"

          gh release create "$VERSION" \
            --title "MailVault v${VERSION#v}" \
            --notes "See the assets to download and install this version." \
            --draft \
            $UPLOAD_FILES

          echo "Draft release created: $VERSION"
